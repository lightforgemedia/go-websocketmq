<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketMQ Simple Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .status-container {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .status-label {
            font-weight: bold;
            margin-right: 10px;
        }
        #status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            background-color: #f8f8f8;
        }
        #status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        #status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        #status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .client-info {
            margin-top: 10px;
        }
        .client-info span {
            font-family: monospace;
            background-color: #f8f8f8;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <h1>WebSocketMQ Simple Test</h1>
    
    <div class="status-container">
        <div>
            <span class="status-label">Status:</span>
            <span id="status" class="disconnected">Disconnected</span>
        </div>
        <div class="client-info">
            <span class="status-label">Page Session ID:</span>
            <span id="page-id">N/A</span>
        </div>
        <div class="client-info">
            <span class="status-label">Broker Client ID:</span>
            <span id="client-id">N/A</span>
        </div>
    </div>

    <script>
        // Get WebSocket URL from query parameter or use default
        const urlParams = new URLSearchParams(window.location.search);
        const wsURL = urlParams.get('ws') || 'ws://localhost:8080/ws';
        
        // Set up console history for test debugging
        if (!window.console.history) {
            window.console.history = [];
            const oldLog = console.log;
            const oldInfo = console.info;
            const oldWarn = console.warn;
            const oldError = console.error;
            
            console.log = function() {
                window.console.history.push({type: 'log', args: Array.from(arguments)});
                oldLog.apply(console, arguments);
            };
            console.info = function() {
                window.console.history.push({type: 'info', args: Array.from(arguments)});
                oldInfo.apply(console, arguments);
            };
            console.warn = function() {
                window.console.history.push({type: 'warn', args: Array.from(arguments)});
                oldWarn.apply(console, arguments);
            };
            console.error = function() {
                window.console.history.push({type: 'error', args: Array.from(arguments)});
                oldError.apply(console, arguments);
            };
        }

        // Wait for WebSocketMQ script to load
        document.addEventListener('DOMContentLoaded', function() {
            const script = document.createElement('script');
            script.src = '/wsmq/websocketmq.js';
            script.onload = initClient;
            script.onerror = function(e) {
                console.error('Failed to load WebSocketMQ script:', e);
                document.getElementById('status').textContent = 'Script Load Error';
                document.getElementById('status').className = 'error';
            };
            document.head.appendChild(script);
        });

        function initClient() {
            console.log('WebSocketMQ script loaded, initializing client...');
            
            const statusEl = document.getElementById('status');
            const pageIdEl = document.getElementById('page-id');
            const clientIdEl = document.getElementById('client-id');
            
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'connecting';
            
            // Generate a page session ID (normally your app would manage this)
            const pageSessionId = 'page-' + Math.random().toString(36).substring(2, 15);
            pageIdEl.textContent = pageSessionId;
            
            // Initialize WebSocketMQ client
            const client = new WebSocketMQ({
                url: wsURL,
                pageSessionId: pageSessionId,
                debug: true,
                reconnect: true,
                reconnectInterval: 2000,
                maxReconnectAttempts: 5
            });
            
            // Set up event handlers
            client.on('open', () => {
                console.log('WebSocket connection opened');
                statusEl.textContent = 'Connected';
                statusEl.className = 'connected';
            });
            
            client.on('close', () => {
                console.log('WebSocket connection closed');
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'disconnected';
            });
            
            client.on('error', (error) => {
                console.error('WebSocket error:', error);
                statusEl.textContent = 'Error';
                statusEl.className = 'error';
            });
            
            // Listen for client registration ACK to get the broker client ID
            client.subscribe('_client.registered', (data) => {
                console.log('Registration ACK received:', data);
                if (data && data.brokerClientID) {
                    clientIdEl.textContent = data.brokerClientID;
                }
            });
            
            // Store client in window for debugging
            window.wsmqClient = client;
            
            console.log('WebSocketMQ client initialized with page session ID:', pageSessionId);
        }
    </script>
</body>
</html>
