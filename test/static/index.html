<!DOCTYPE html>
<html>
<head>
    <title>WebSocketMQ Browser Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .message-container {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            padding: 8px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0069d9;
        }
    </style>
</head>
<body>
    <h1>WebSocketMQ Browser Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div class="controls">
        <button id="publishBtn">Publish Message</button>
        <button id="subscribeBtn">Subscribe to Topic</button>
        <button id="requestBtn">Send Request</button>
        <button id="clearBtn">Clear Messages</button>
    </div>
    
    <h3>Messages:</h3>
    <div id="messages" class="message-container"></div>
    
    <script src="/wsmq/websocketmq.min.js"></script>
    <script>
        // Create a global client instance
        window.client = new WebSocketMQ.Client({
            url: 'ws://' + window.location.host + '/ws',
            reconnect: true,
            reconnectInterval: 1000,
            maxReconnectInterval: 30000,
            reconnectMultiplier: 1.5,
            devMode: false
        });
        
        // Set up event handlers
        client.onConnect(() => {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Connected';
            statusEl.className = 'status connected';
            console.log('Connected to server');
        });
        
        client.onDisconnect(() => {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'status disconnected';
            console.log('Disconnected from server');
        });
        
        client.onError((err) => {
            console.error('WebSocket error:', err);
        });
        
        // Function to add a message to the messages div
        window.addMessage = function(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
        };
        
        // Function to clear messages
        window.clearMessages = function() {
            document.getElementById('messages').innerHTML = '';
        };
        
        // Function to publish a message
        window.publishMessage = function(topic, body) {
            client.publish(topic, body);
            addMessage('Published to ' + topic + ': ' + JSON.stringify(body));
            console.log('Published message to topic:', topic, body);
            return true; // For testing
        };
        
        // Function to subscribe to a topic
        window.subscribeToTopic = function(topic, callback) {
            addMessage('Subscribed to topic: ' + topic);
            return client.subscribe(topic, (body, message) => {
                addMessage('Received on ' + topic + ': ' + JSON.stringify(body));
                console.log('Received message on topic:', topic, body);
                if (callback) {
                    callback(body, message);
                }
            });
        };
        
        // Function to make a request
        window.makeRequest = function(topic, body, timeout) {
            addMessage('Sending request to ' + topic + ': ' + JSON.stringify(body));
            return client.request(topic, body, timeout)
                .then(response => {
                    addMessage('Received response: ' + JSON.stringify(response));
                    console.log('Received response:', response);
                    return response;
                })
                .catch(err => {
                    addMessage('Request error: ' + err.message);
                    console.error('Request error:', err);
                    throw err;
                });
        };
        
        // Set up button handlers
        document.getElementById('publishBtn').addEventListener('click', () => {
            publishMessage('test.publish', {test: 'publish', time: new Date().toISOString()});
        });
        
        document.getElementById('subscribeBtn').addEventListener('click', () => {
            subscribeToTopic('test.subscribe', (body, message) => {
                console.log('Subscription callback:', body);
            });
        });
        
        document.getElementById('requestBtn').addEventListener('click', () => {
            makeRequest('test.request', {test: 'request', time: new Date().toISOString()}, 5000);
        });
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            clearMessages();
        });
        
        // Connect to the server
        client.connect();
    </script>
</body>
</html>
