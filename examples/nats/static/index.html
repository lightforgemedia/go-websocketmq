<!DOCTYPE html>
<html>
<head>
    <title>WebSocketMQ NATS Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        #log {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f5f5f5;
            font-family: monospace;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-time {
            color: #888;
            font-size: 0.8em;
        }
        .log-message {
            margin-left: 10px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>WebSocketMQ NATS Example</h1>
    
    <div class="card">
        <h2>Connection Status</h2>
        <div id="status">Disconnected</div>
        <button id="connect">Connect</button>
        <button id="disconnect">Disconnect</button>
    </div>
    
    <div class="card">
        <h2>Publish Message</h2>
        <div>
            <label for="topic">Topic:</label>
            <input type="text" id="topic" value="user.login">
        </div>
        <div style="margin-top: 10px;">
            <label for="message">Message:</label>
            <input type="text" id="message" value='{"username": "test"}'>
        </div>
        <div style="margin-top: 10px;">
            <button id="publish">Publish</button>
        </div>
    </div>
    
    <div class="card">
        <h2>Request/Response</h2>
        <div>
            <label for="request-topic">Topic:</label>
            <input type="text" id="request-topic" value="server.echo">
        </div>
        <div style="margin-top: 10px;">
            <label for="request-message">Message:</label>
            <input type="text" id="request-message" value='{"message": "Hello, NATS!"}'>
        </div>
        <div style="margin-top: 10px;">
            <button id="request">Send Request</button>
        </div>
    </div>
    
    <div class="card">
        <h2>Log</h2>
        <div id="log"></div>
    </div>
    
    <script src="/wsmq/websocketmq.min.js"></script>
    <script>
        // Initialize client
        let client = null;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const publishBtn = document.getElementById('publish');
        const requestBtn = document.getElementById('request');
        const topicInput = document.getElementById('topic');
        const messageInput = document.getElementById('message');
        const requestTopicInput = document.getElementById('request-topic');
        const requestMessageInput = document.getElementById('request-message');
        
        // Log function
        function log(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = document.createElement('span');
            time.className = 'log-time';
            time.textContent = new Date().toLocaleTimeString();
            
            const msg = document.createElement('span');
            msg.className = 'log-message';
            msg.textContent = message;
            
            entry.appendChild(time);
            entry.appendChild(msg);
            
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Connect button
        connectBtn.addEventListener('click', () => {
            if (client) return;
            
            client = new WebSocketMQ.Client({
                url: `ws://${window.location.host}/ws`,
                reconnect: true,
                devMode: true
            });
            
            client.onConnect(() => {
                statusEl.textContent = 'Connected';
                statusEl.style.color = 'green';
                log('Connected to server');
                
                // Subscribe to server.tick
                client.subscribe('server.tick', (body) => {
                    log(`Received tick: ${body.time}`);
                });
            });
            
            client.onDisconnect(() => {
                statusEl.textContent = 'Disconnected';
                statusEl.style.color = 'red';
                log('Disconnected from server');
            });
            
            client.onError((err) => {
                log(`Error: ${err}`);
            });
            
            client.connect();
        });
        
        // Disconnect button
        disconnectBtn.addEventListener('click', () => {
            if (!client) return;
            
            client.disconnect();
            client = null;
        });
        
        // Publish button
        publishBtn.addEventListener('click', () => {
            if (!client) {
                log('Not connected');
                return;
            }
            
            const topic = topicInput.value;
            let message;
            
            try {
                message = JSON.parse(messageInput.value);
            } catch (err) {
                log(`Invalid JSON: ${err.message}`);
                return;
            }
            
            try {
                client.publish(topic, message);
                log(`Published to ${topic}: ${messageInput.value}`);
            } catch (err) {
                log(`Error publishing: ${err.message}`);
            }
        });
        
        // Request button
        requestBtn.addEventListener('click', async () => {
            if (!client) {
                log('Not connected');
                return;
            }
            
            const topic = requestTopicInput.value;
            let message;
            
            try {
                message = JSON.parse(requestMessageInput.value);
            } catch (err) {
                log(`Invalid JSON: ${err.message}`);
                return;
            }
            
            try {
                log(`Sending request to ${topic}: ${requestMessageInput.value}`);
                const response = await client.request(topic, message, 5000);
                log(`Received response: ${JSON.stringify(response)}`);
            } catch (err) {
                log(`Error with request: ${err.message}`);
            }
        });
    </script>
</body>
</html>
